"use strict";angular.module("wgafApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router","config","angular-flash.service","angular-flash.flash-alert-directive","siyfion.sfTypeahead","angular-loading-bar","ui.utils"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","flashProvider",function(a,b,c,d){a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl","abstract":!0}).state("main.share",{url:"",templateUrl:"views/share-link.html"}).state("main.follow",{url:"",templateUrl:"views/follow.html"}).state("cover",{url:"/",templateUrl:"views/cover.html",controller:"CoverCtrl"}).state("cover.sign-in",{url:"signin",templateUrl:"views/sign-in.html"}).state("cover.sign-up",{url:"signup",templateUrl:"views/sign-up.html"}).state("cover.sign-up.verify",{url:"",templateUrl:"views/verify-email.html"}),b.otherwise("/"),c.interceptors.push("authInterceptor"),d.errorClassnames.push("alert-danger"),d.warnClassnames.push("alert-warn"),d.infoClassnames.push("alert-info"),d.successClassnames.push("alert-success")}]).run(["$state","$window","$rootScope",function(a,b,c){var d=[/^main/];c.$on("$stateChangeStart",function(c,e){for(var f=0;f<d.length;++f)d[f].test(e.name)&&!b.sessionStorage.user&&(c.preventDefault(),a.go("cover"))})}]),angular.module("config",[]).constant("ENV","production").constant("API","https://wgaf.herokuapp.com"),angular.module("wgafApp").directive("userSearch",["API",function(a){return{restrict:"E",scope:{model:"=",valid:"="},templateUrl:"views/user-search.html",controller:["$scope",function(b){b.valid=!1;var c=[],d=new Bloodhound({name:"users",remote:{url:a+"/users?search=%QUERY",filter:function(a){return b.$apply(function(){c=_.union(c,_.map(a,"username"))}),a}},datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.username)},queryTokenizer:Bloodhound.tokenizers.whitespace});d.initialize(),b.userData={name:"usernames",displayKey:"username",source:d.ttAdapter()},b.$watch(function(a){return{cache:c,model:a.model}},function(){b.valid=_.contains(c,b.model)},!0)}]}}]),angular.module("wgafApp").controller("MainCtrl",["$scope","$window","$state","$http","API","$log","flash",function(a,b,c,d,e,f,g){a.user=angular.fromJson(b.sessionStorage.user),a.share={url:null,summary:"",reset:function(){this.url=null,this.summary=null}},a.sharing=!1,a.follow={username:null,valid:!1,reset:function(){this.username=null,this.valid=!1}},a.following=!1,a.signout=function(){delete b.sessionStorage.user,c.go("cover")},a.shareLink=function(b){a.sharing=!0,d.post(e+"/users/"+a.user.username+"/links",a.share).success(function(){g.success="Link added",a.share.reset(),b.$setPristine()}).error(function(a){g.error="Something went wrong...",f.error(a)})["finally"](function(){a.sharing=!1})},a.followUser=function(){a.following=!0,d.post(e+"/users/"+a.user.username+"/following",{target:a.follow.username}).success(function(){g.success="Following "+a.follow.username,a.follow.reset()}).error(function(b){f.error("Error following user: ",b),/^already following/.test(b.message)&&(g.info="Already following "+a.follow.username,a.follow.reset())})["finally"](function(){a.following=!1})}}]),angular.module("wgafApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wgafApp").controller("CoverCtrl",["$scope","$http","API","$window","$log","$state","flash",function(a,b,c,d,e,f,g){d.sessionStorage.user&&f.go("main.share"),a.user={},a.signingIn=!1,a.signingUp=!1,a.signInText=function(){return a.signingIn?"Signing in...":"Sign in"},a.signUpText=function(){return a.signingUp?"Signing up...":"Sign up"},a.signIn=function(){delete a.signInError,a.signingIn=!0,b.post(c+"/auth",a.user).success(function(b){d.sessionStorage.user=angular.toJson({username:a.user.username,token:b.token}),f.go("main.share")}).error(function(b){delete d.sessionStorage.token,a.signingIn=!1,"email not verified"===b.message?a.signInError=a.user.username+", please verify your email before signing in.":"bad auth"===b.message?a.signInError="Invalid username or password.":g.error="Something went wrong..."})},a.signUp=function(){delete a.signUpError,a.signingUp=!0,b.post(c+"/users",a.user).success(function(b){e.info("signed up: ",b),a.signingUp=!1,g.success="Account created",f.go("cover.sign-up.verify")}).error(function(b){"username already exists"===b.message&&(a.signUpError="Username is taken. Please pick another username."),a.signingUp=!1})}}]),angular.module("wgafApp").factory("authInterceptor",["$window","$log","$q","$location",function(a,b,c,d){return{request:function(b){b.headers=b.headers||{};var c=angular.fromJson(a.sessionStorage.user);return a.sessionStorage.user&&(b.headers.Authorization="Bearer "+c.token),b},response:function(e){return 401===e.status&&(b.warn("Not authenticated: ",e),delete a.sessionStorage.user,d.path("/signin")),e||c.when(e)}}}]),angular.module("wgafApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>\n"),a.put("views/cover.html",'<div class="banner">\n    <h1>w.g.a.f</h1>\n    <p>No nonsense web curation tool. Get one email daily, with updates from the people you choose.</p>\n</div>\n\n<div class="action">\n  <div ui-view>\n        <button type="button" class="btn btn-default btn-lg" ui-sref=".sign-in">Sign in</button>\n        <div>\n            or <a ui-sref=".sign-up">Sign up</a>\n        </div>\n    </div>\n</div>\n'),a.put("views/follow.html",'<form role="form" class="wgaf-action-form wgaf-follow-form form-inline">\n  <div class="form-group">\n    <user-search model="follow.username" valid="follow.valid"/>\n  </div>\n  <button ng-disabled="following || !follow.valid || follow.username === user.username" type="submit" class="btn btn-default btn-lg" ng-click="followUser()">Follow</button>\n</form>\n'),a.put("views/main.html",'<div class="header">\n  <h1>w.g.a.f</h1>\n  <div>\n    Hello, {{user.username}}.\n    <ul class="nav-list pull-right">\n      <li><a ui-sref="main.share">Share link</a></li>\n      <li><a ui-sref="main.follow">Follow</a></li>\n      <li><a ng-click="signout()">Sign out</a></li>\n    </ul>\n  </div>\n</div>\n\n<div ui-view>\n  <p>Get started by sharing a link, or following a user.</p>\n</div>\n'),a.put("views/share-link.html",'<form role="form" name="shareForm" class="wgaf-action-form wgaf-share-link-form">\n  <div class="form-group">\n    <input ng-model="share.url" type="url" placeholder="Link" class="form-control"\n           required="true"/>\n  </div>\n  <div class="form-group">\n    <textarea ng-model="share.summary" rows="2" placeholder="A short summary, if you like." ng-maxlength="160" class="form-control"></textarea>\n  </div>\n  <div class="action">\n    <button ng-disabled="sharing || shareForm.$invalid" type="button" class="btn btn-default btn-lg" ng-click="shareLink(shareForm)">g.a.f</button>\n  </div>\n</form>\n'),a.put("views/sign-in.html",'<form role="form" name="signInForm">\n  <p class="text-danger" ng-if="signInError">{{signInError}}</p>\n    <div class="form-group">\n        <input type="text" class="form-control" placeholder="Username" ng-model="user.username" required="true">\n        <div class="form-group">\n            <input type="password" class="form-control" placeholder="Password" ng-model="user.password" required="true">\n        </div>\n    </div>\n    <div class="action">\n        <button ng-disabled="signingIn || signInForm.$invalid" type="submit" class="btn btn-default btn-lg" ng-click="signIn()">{{signInText()}}</button>\n        <div ng-hide="signingIn">\n            or <a ui-sref="cover.sign-up">Sign up</a>\n        </div>\n    </div>\n\n</form>\n'),a.put("views/sign-up.html",'<div ui-view>\n  <form role="form" name="signUpForm" show-validation>\n    <p class="text-danger" ng-if="signUpError">{{signUpError}}</p>\n    <div class="form-group">\n        <input type="email" class="form-control" placeholder="Email" ng-model="user.email" required="true">\n    </div>\n    <div class="form-group">\n        <input type="text" class="form-control" placeholder="Username" ng-model="user.username" required="true" pattern="^[A-Za-z][_A-Za-z0-9]*$">\n    </div>\n    <div class="form-group">\n        <input type="password" class="form-control" placeholder="Password" ng-model="user.password" required="true" ng-minlength="4">\n    </div>\n    <div class="form-group">\n        <input type="password" class="form-control" placeholder="Confirm password" ng-model="user.confirmPassword" ui-validate="\'$value===user.password\'" ui-validate-watch="\'user.password\'">\n    </div>\n\n    <div class="action">\n        <button ng-disabled="signingUp || signUpForm.$invalid" type="submit" class="btn btn-default btn-lg" ng-click="signUp()">{{signUpText()}}</button>\n        <div ng-hide="signingUp">\n            or <a ui-sref="cover.sign-in">Sign in</a>\n        </div>\n    </div>\n</form>\n</div>\n'),a.put("views/user-search.html",'<input type="text"\n       class="form-control"\n       placeholder="Username"\n       ng-model="model"\n       datasets="userData"\n       options="{highlight:true}"\n       sf-typeahead\n       suggestion-key="username" />\n'),a.put("views/verify-email.html","<p><strong>{{user.username}}</strong>, your account has been created. We have sent a verification email to <strong>{{user.email}}</strong>. Please verify your email before signing in.</p>\n")}]);